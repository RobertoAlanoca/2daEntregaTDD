name: Blue-Green Deployment CI/CD Pipeline

on:
  push:
    branches: [ main, TDD, ATDD ]
  pull_request:
    branches: [ main, TDD, ATDD ]

jobs:
  # ========================================
  # BLUE PHASE: Pre-Deploy Testing
  # Tests que deben pasar antes del deploy
  # ========================================
  blue-phase:
    name: "ğŸ”µ Blue Phase - Pre-Deploy Tests"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ“¦ Cache del repositorio Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven

      - name: ğŸ”¨ Compilar aplicaciÃ³n
        run: mvn clean compile

      - name: ğŸ§ª Ejecutar tests unitarios (Blue Phase)
        run: mvn test -Punit-tests
        env:
          CI: true

      - name: ğŸ“Š Subir reportes de tests unitarios
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blue-phase-test-reports
          path: target/surefire-reports/

      - name: âœ… Blue Phase completada
        run: echo "ğŸ”µ Blue Phase tests passed - Ready for deployment"

  # ========================================
  # DEPLOY PHASE: Build and Package
  # ConstrucciÃ³n del artefacto deployable
  # ========================================
  deploy-phase:
    name: "ğŸ“¦ Deploy Phase - Build & Package"
    runs-on: ubuntu-latest
    needs: blue-phase
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ“¦ Cache del repositorio Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven

      - name: ğŸ”¨ Construir aplicaciÃ³n (sin tests)
        run: mvn clean package -DskipTests

      - name: ğŸ“¦ Subir artefacto JAR
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app
          path: target/*.jar

      - name: âœ… Deploy Phase completada
        run: echo "ğŸ“¦ Application packaged successfully"

  # ========================================
  # GREEN PHASE: Post-Deploy Testing
  # Tests end-to-end en el entorno desplegado
  # ========================================
  green-phase:
    name: "ğŸŸ¢ Green Phase - Post-Deploy Tests"
    runs-on: ubuntu-latest
    needs: [blue-phase, deploy-phase]
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ“¦ Cache del repositorio Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven

      - name: ğŸ“¥ Descargar artefacto JAR
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app
          path: target/

      - name: ğŸŒ Instalar Google Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: ğŸ–¥ï¸ Configurar Xvfb (Display Virtual)
        run: |
          sudo apt-get install -y xvfb
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &

      - name: ğŸš€ Iniciar aplicaciÃ³n Spring Boot (Green Environment)
        run: |
          java -jar target/*.jar &
          echo $! > app.pid
          sleep 30  # Esperar a que la aplicaciÃ³n arranque
        env:
          CI: true

      - name: ğŸ” Verificar que la aplicaciÃ³n estÃ© corriendo
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done'
          echo "âœ… Application is running and responding"

      - name: ğŸ§ª Ejecutar tests de integraciÃ³n (Green Phase)
        run: mvn test -Pintegration-tests -Dheadless=true
        env:
          CI: true
          DISPLAY: :99

      - name: ğŸ›‘ Detener aplicaciÃ³n Spring Boot
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            rm app.pid
          fi

      - name: ğŸ“Š Subir reportes de tests de integraciÃ³n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: green-phase-test-reports
          path: target/surefire-reports/

      - name: âœ… Green Phase completada
        run: echo "ğŸŸ¢ Green Phase tests passed - Deployment validated successfully"

  # ========================================
  # DEPLOYMENT STATUS: Final Status Report
  # Resumen final del deployment Blue-Green
  # ========================================
  deployment-status:
    name: "ğŸ“‹ Deployment Status Report"
    runs-on: ubuntu-latest
    needs: [blue-phase, deploy-phase, green-phase]
    if: always()
    
    steps:
      - name: ğŸ“Š Evaluating deployment status
        run: |
          echo "==================================="
          echo "ğŸ”µğŸŸ¢ BLUE-GREEN DEPLOYMENT REPORT"
          echo "==================================="
          echo "Blue Phase (Pre-Deploy): ${{ needs.blue-phase.result }}"
          echo "Deploy Phase (Build): ${{ needs.deploy-phase.result }}"
          echo "Green Phase (Post-Deploy): ${{ needs.green-phase.result }}"
          echo "==================================="
          
          if [[ "${{ needs.blue-phase.result }}" == "success" && "${{ needs.deploy-phase.result }}" == "success" && "${{ needs.green-phase.result }}" == "success" ]]; then
            echo "âœ… DEPLOYMENT SUCCESSFUL - All phases completed"
            echo "ğŸ‰ Application ready for production"
          else
            echo "âŒ DEPLOYMENT FAILED - Check phase results"
            exit 1
          fi
